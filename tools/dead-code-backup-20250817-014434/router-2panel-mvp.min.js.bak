const $=(t,e=document)=>e.querySelector(t),$$=(t,e=document)=>Array.from(e.querySelectorAll(t)),html=t=>{const e=document.createElement("template");return e.innerHTML=t.trim(),e.content.firstElementChild};function delegate(t,e,a,n,o){t.addEventListener(e,e=>{const o=e.target.closest(a);o&&t.contains(o)&&n(e,o)},o)}function mountOverlay(t){return t.classList.add("panel"),document.body.appendChild(t),requestAnimationFrame(()=>t.classList.add("panel--active")),t}function unmountOverlay(t){t?.classList.remove("panel--active"),setTimeout(()=>t?.remove(),220)}const API_BASE="https://us-central1-conference-party-app.cloudfunctions.net";async function getJSON(t){const e=await fetch(t,{headers:{accept:"application/json"}});if(!e.ok)throw new Error(`HTTP ${e.status} for ${t}`);return await e.json().catch(()=>({}))}async function fetchParties(){const t=await getJSON(`${API_BASE}/api/parties?conference=gamescom2025`);return Array.isArray(t?.data)?t.data:Array.isArray(t)?t:t?.parties||[]}function pad(t){return String(t).padStart(2,"0")}function toICS(t){const e=new Date(t);return`${e.getUTCFullYear()}${pad(e.getUTCMonth()+1)}${pad(e.getUTCDate())}T${pad(e.getUTCHours())}${pad(e.getUTCMinutes())}00Z`}function openICS(t){if(t.id)return void window.open(`/api/calendar/ics?partyId=${encodeURIComponent(t.id)}`,"_blank");const e=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//ConferenceParty//EN","BEGIN:VEVENT",`UID:${crypto.randomUUID()}`,`DTSTART:${toICS(t.start||t.date)}`,`DTEND:${toICS(t.end||t.start||t.date)}`,`SUMMARY:${t.title||"Party"}`,`LOCATION:${t.venue||""}`,`DESCRIPTION:${(t.desc||"").replace(/\n/g,"\\n")}`,"END:VEVENT","END:VCALENDAR"].join("\r\n"),a=new Blob([e],{type:"text/calendar"}),n=URL.createObjectURL(a),o=document.createElement("a");o.href=n,o.download=`${t.title||"event"}.ics`,o.click(),setTimeout(()=>URL.revokeObjectURL(n),1e3)}function openGoogle(t){const e=new URLSearchParams({action:"TEMPLATE",text:t.title||"Party",dates:`${toICS(t.start||t.date)}/${toICS(t.end||t.start||t.date)}`,details:t.desc||"",location:t.venue||""});window.open(`https://calendar.google.com/calendar/render?${e}`,"_blank")}function cardFor(t){const e=document.createElement("div");return e.className="card",e.innerHTML=`\n    <h3 class="card__title">${t.title||"Party"}</h3>\n    <div class="card__meta">${t.date||""} ${t.time||""} — ${t.venue||""}</div>\n    <div class="card__actions">\n      <button class="btn btn--primary" data-action="cal-ics">Add to Calendar</button>\n      <button class="btn btn--ghost" data-action="cal-google">Google</button>\n    </div>`,e.addEventListener("click",e=>{const a=e.target.closest("[data-action]");a&&("cal-ics"===a.dataset.action&&openICS(t),"cal-google"===a.dataset.action&&openGoogle(t))},{passive:!0}),e}const state={week:null};function startOfWeekMonday(t){const e=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())),a=(e.getUTCDay()+6)%7;return e.setUTCDate(e.getUTCDate()-a),e}function fmtDayLabel(t){return new Date(t+"T00:00:00Z").toLocaleDateString(void 0,{weekday:"short",day:"2-digit"}).replace(",","")}async function computeWeek(){if(state.week)return state.week;const t=(await fetchParties()).map(t=>(t.date||t.start||"").slice(0,10)).filter(Boolean).sort(),e=startOfWeekMonday(t[0]?new Date(t[0]+"T00:00:00Z"):new Date),a=Array.from({length:6},(t,a)=>{const n=new Date(e);n.setUTCDate(e.getUTCDate()+a);const o=n.toISOString().slice(0,10);return{iso:o,label:fmtDayLabel(o)}});return state.week={days:a,selected:a[0].iso},state.week}function ensureHome(){const t=$(".home-wrap")||document.body.appendChild(html('<main class="home-wrap"></main>'));if($('.home-section[data-section="parties"]',t)||t.appendChild(html('<section class="home-section" data-section="parties"><h2>Parties</h2><div class="day-pills" data-target="parties"></div></section>')),$('.home-section[data-section="map"]',t)||t.appendChild(html('<section class="home-section" data-section="map"><h2>Map</h2><div class="day-pills" data-target="map"></div></section>')),!$(".channels-grid",t)){const e=html('<section class="home-section"><div class="channels-grid">\n      <a class="channel-btn" data-route="#/map"><div>📍</div><strong>Map</strong></a>\n      <a class="channel-btn" data-route="#/calendar"><div>📅</div><strong>My calendar</strong></a>\n      <a class="channel-btn" data-route="#/invites"><div>✉️</div><strong>Invites</strong></a>\n      <a class="channel-btn" data-route="#/contacts"><div>👥</div><strong>Contacts</strong></a>\n      <a class="channel-btn" data-route="#/me"><div>👤</div><strong>Me</strong></a>\n      <a class="channel-btn" data-route="#/settings"><div>⚙️</div><strong>Settings</strong></a>\n    </div></section>');t.prepend(e)}return t}async function renderHome(){const t=ensureHome(),{days:e,selected:a}=await computeWeek();for(const n of["parties","map"]){$(`.day-pills[data-target="${n}"]`,t).innerHTML=e.map(t=>`<button class="day-pill" data-target="${n}" data-date="${t.iso}" aria-pressed="${t.iso===a}">${t.label}</button>`).join("")}}function headerHTML(t){return`<header class="panel__header"><button class="panel__back" data-action="back">← Back</button><h1 class="panel__title">${t}</h1></header>`}function mountPanel(t){const e=html(`<section class="panel" role="dialog" aria-modal="true">${headerHTML(t)}<div class="panel__body"></div></section>`);return mountOverlay(e),delegate(e,"click",'[data-action="back"]',()=>unmountOverlay(e)),e.querySelector(".panel__body")}async function mountParties(t){const e=mountPanel(`Parties — ${fmtDayLabel(t)}`),a=html('<div class="card-list" />');e.appendChild(a);const n=(await fetchParties()).filter(e=>(e.date||e.start||"").slice(0,10)===t);if(n.length)for(const t of n)a.appendChild(cardFor(t));else a.appendChild(html(`<div class="card"><p>No parties for ${fmtDayLabel(t)}.</p></div>`))}async function mountMap(t){const e=mountPanel(`Map — ${fmtDayLabel(t)}`),a=html('<div id="map" style="height:60vh;border-radius:16px;overflow:hidden;"></div>');e.appendChild(a);const n=()=>window.google?.maps?.Map;let o=n();o||(await new Promise(t=>{const e=setInterval(()=>{n()&&(clearInterval(e),t(null))},100)}),o=window.google.maps);const s=new o.Map(a,{center:{lat:50.9375,lng:6.9603},zoom:12,mapId:"DEMO_MAP_ID"}),i=(await fetchParties()).map(t=>{const e=Number(t.lat??t.latitude??t.location?.lat??t.coords?.lat),a=Number(t.lng??t.longitude??t.location?.lng??t.coords?.lng);return{...t,ok:Number.isFinite(e)&&Number.isFinite(a),lat:e,lng:a,date:(t.date||t.start||"").slice(0,10)}}).filter(e=>e.ok&&e.date===t),c=new o.LatLngBounds;for(const t of i){if(o.marker?.AdvancedMarkerElement){const e=document.createElement("div");e.textContent="●",e.style.fontSize="18px",e.style.color="#6b7bff",new o.marker.AdvancedMarkerElement({map:s,position:{lat:t.lat,lng:t.lng},content:e,title:t.title||"Party"})}c.extend({lat:t.lat,lng:t.lng})}i.length&&s.fitBounds(c,48)}function mountStub(t,e){mountPanel(t).innerHTML=`<p>${e}</p>`}function go(t){if(!t||"#"===t||"#/"===t)return void(location.hash="#/home");const e=t.slice(2).split("/"),[a,n]=e;"home"!==a?"parties"!==a?"map"!==a?"calendar"!==a?"invites"!==a?"contacts"!==a?"me"!==a?"settings"!==a||mountStub("Settings","Settings coming soon."):mountStub("Me","Profile coming soon."):mountStub("Contacts","Contacts coming soon."):mountStub("Invites","Invitations coming soon."):mountStub("My calendar","Calendar view coming soon."):mountMap(n||state.week?.selected||(new Date).toISOString().slice(0,10)):mountParties(n||state.week?.selected||(new Date).toISOString().slice(0,10)):renderHome()}window.addEventListener("hashchange",()=>go(location.hash)),document.addEventListener("DOMContentLoaded",()=>{location.hash||(location.hash="#/home"),go(location.hash)}),document.addEventListener("click",t=>{const e=t.target.closest("[data-route]");e&&(t.preventDefault(),location.hash=e.dataset.route);const a=t.target.closest(".day-pill[data-target][data-date]");if(a&&a.closest(".home-wrap")){const t=a.dataset.date,e=a.dataset.target;"parties"===e&&(location.hash=`#/parties/${t}`),"map"===e&&(location.hash=`#/map/${t}`)}},{passive:!0});