name: Design Token Enforcement

on:
  pull_request:
    paths:
      - 'frontend/src/**/*.css'
      - 'frontend/src/**/*.scss'
      - 'frontend/src/**/*.less'
      - 'frontend/src/**/*.html'
      - 'frontend/src/**/*.js'
      - 'frontend/src/**/*.ts'
      - 'frontend/src/**/*.jsx'
      - 'frontend/src/**/*.tsx'
      - 'frontend/src/**/*.svg'
  push:
    branches: [main, develop]
    paths:
      - 'frontend/src/**/*.css'
      - 'frontend/src/**/*.scss'
      - 'frontend/src/**/*.less'
      - 'frontend/src/**/*.html'
      - 'frontend/src/**/*.js'
      - 'frontend/src/**/*.ts'
      - 'frontend/src/**/*.jsx'
      - 'frontend/src/**/*.tsx'
      - 'frontend/src/**/*.svg'

jobs:
  check-tokens:
    name: Check Design Tokens
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup ripgrep
        run: |
          curl -LO https://github.com/BurntSushi/ripgrep/releases/download/13.0.0/ripgrep_13.0.0_amd64.deb
          sudo dpkg -i ripgrep_13.0.0_amd64.deb
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check for hardcoded px values
        run: npm run lint:tokens
          
      - name: Comment on PR if violations found
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            ‚ö†Ô∏è **Design Token Violations Found**
            
            This PR contains hardcoded px values that should use design tokens.
            
            **Quick Reference:**
            - Spacing: \`4px\` ‚Üí \`var(--s-1)\`, \`8px\` ‚Üí \`var(--s-2)\`, \`12px\` ‚Üí \`var(--s-3)\`, \`16px\` ‚Üí \`var(--s-4)\`
            - More: \`20px\` ‚Üí \`var(--s-5)\`, \`24px\` ‚Üí \`var(--s-6)\`, \`32px\` ‚Üí \`var(--s-7)\`, \`40px\` ‚Üí \`var(--s-8)\`
            - Radius: \`8px\` ‚Üí \`var(--r-md)\`, \`12px\` ‚Üí \`var(--r-lg)\`, \`16px\` ‚Üí \`var(--r-xl)\`
            
            Run \`npm run check:tokens\` locally to see specific violations.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
            
  validate-token-definitions:
    name: Validate Token Definitions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check spacing-tokens.css exists
        run: |
          if [ ! -f "frontend/src/assets/css/spacing-tokens.css" ]; then
            echo "‚ùå spacing-tokens.css not found!"
            exit 1
          fi
          echo "‚úÖ spacing-tokens.css found"
          
      - name: Validate token definitions
        run: |
          # Check that essential tokens are defined
          TOKENS=(
            "--s-1" "--s-2" "--s-3" "--s-4" "--s-5" "--s-6" "--s-7" "--s-8"
            "--r-xs" "--r-sm" "--r-md" "--r-lg" "--r-xl" "--r-2xl" "--r-full"
          )
          
          for token in "${TOKENS[@]}"; do
            if ! grep -q "$token:" frontend/src/assets/css/spacing-tokens.css; then
              echo "‚ùå Token $token not defined in spacing-tokens.css"
              exit 1
            fi
          done
          
          echo "‚úÖ All essential tokens are defined"
          
      - name: Check token loading in HTML
        run: |
          if ! grep -q "spacing-tokens.css" frontend/src/index.html; then
            echo "‚ö†Ô∏è Warning: spacing-tokens.css not loaded in index.html"
          else
            echo "‚úÖ spacing-tokens.css is loaded in index.html"
          fi

  hex-color-guard:
    name: Hex Color Guard (Zero Tolerance)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup ripgrep
        run: |
          curl -LO https://github.com/BurntSushi/ripgrep/releases/download/13.0.0/ripgrep_13.0.0_amd64.deb
          sudo dpkg -i ripgrep_13.0.0_amd64.deb
          
      - name: Guard: no hex colors anywhere
        run: |
          echo "üîç Scanning for hex colors in frontend/src..."
          
          # Use ripgrep to find any hex colors, excluding token files and backups
          if rg -n --hidden --glob '!**/tokens/**' --glob '!**/backup/**' \
            -e '#[0-9a-fA-F]{3,8}\b' frontend/src; then
            echo ""
            echo "‚ùå HARD GATE FAILURE: Hex colors found in codebase!"
            echo ""
            echo "All colors must use design tokens. To fix this:"
            echo "1. Run: node tools/colors/sweep-colors.mjs --write"
            echo "2. Or manually replace hex colors with tokens from:"
            echo "   - frontend/src/assets/css/tokens/color-tokens.css"
            echo "   - frontend/src/assets/css/tokens/_auto-aliases.css"
            echo ""
            echo "Examples:"
            echo "  #ffffff ‚Üí var(--text-inverse)"
            echo "  #000000 ‚Üí var(--text-on-accent)"
            echo "  #6b7bff ‚Üí var(--brand-500)"
            echo "  #22c55e ‚Üí var(--success)"
            echo ""
            exit 1
          else
            echo "‚úÖ No hex colors found - all colors use design tokens!"
          fi
          
      - name: Comment on PR if hex colors found
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            üö´ **HEX COLOR HARD GATE FAILURE**
            
            This PR contains hardcoded hex colors that violate our design token policy.
            
            **‚ùå All hex colors (#ffffff, #000, etc.) are forbidden in:**
            - CSS files
            - HTML inline styles  
            - JavaScript style assignments
            - SVG fill/stroke attributes
            
            **‚úÖ Use design tokens instead:**
            - \`#ffffff\` ‚Üí \`var(--text-inverse)\`
            - \`#000000\` ‚Üí \`var(--text-on-accent)\`
            - \`#6b7bff\` ‚Üí \`var(--brand-500)\`
            - \`#22c55e\` ‚Üí \`var(--success)\`
            
            **üîß Quick Fix:**
            \`\`\`bash
            node tools/colors/sweep-colors.mjs --write
            \`\`\`
            
            **üìñ Token Reference:**
            - Main tokens: \`frontend/src/assets/css/tokens/color-tokens.css\`
            - Auto-aliases: \`frontend/src/assets/css/tokens/_auto-aliases.css\`
            
            This is a hard gate - the build will fail until all hex colors are replaced with tokens.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });